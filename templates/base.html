<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-4063902980761581">
    <title>{% block title %}{{ _('japanese_learning_app') }}{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon1_io/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon1_io/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon1_io/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='favicon1_io/site.webmanifest') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon1_io/favicon.ico') }}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style-retro.css') }}">
    
    <!-- Extra head content for specific pages -->
    {% block extra_head %}{% endblock %}
    
    <!-- Sidebar layout override CSS v4.0 ULTIMATE -->
    <style>
    /* Ultimate nuclear option: Override everything with absolutely maximum specificity */
    html body .main-content .sidebar-layout,
    html body div.main-content div.sidebar-layout,
    html body div.window div.main-content div.sidebar-layout,
    html body div.main-content-wrapper div.window div.main-content div.sidebar-layout,
    body div.main-content div.sidebar-layout,
    div.main-content div.sidebar-layout,
    .main-content .sidebar-layout,
    .sidebar-layout,
    * .sidebar-layout {
      display: flex !important;
      flex-direction: row !important;
      align-items: flex-start !important;
      gap: 16px !important;
      margin-bottom: 12px !important;
      width: 100% !important;
      flex-wrap: nowrap !important;
      box-sizing: border-box !important;
      position: relative !important;
      clear: both !important;
    }
    
    html body .main-content .sidebar-layout > div:first-child,
    html body div.main-content div.sidebar-layout > div:first-child,
    * .sidebar-layout > div:first-child {
      flex: 2 1 60% !important;
      min-width: 0 !important;
      max-width: none !important;
      width: auto !important;
      box-sizing: border-box !important;
    }
    
    html body .main-content .sidebar-layout > div:last-child,
    html body div.main-content div.sidebar-layout > div:last-child, 
    * .sidebar-layout > div:last-child {
      flex: 1 0 250px !important;
      min-width: 250px !important;
      max-width: 350px !important;
      width: auto !important;
      box-sizing: border-box !important;
    }
    
    /* Override any mobile styles that might interfere */
    @media screen and (max-width: 768px) {
      .sidebar-layout {
        flex-direction: column !important;
      }
    }
    @media screen and (max-width: 480px) {
      .sidebar-layout {
        flex-direction: column !important;
      }
    }
    
    /* DESKTOP: Force sidebar layout on large screens */
    @media screen and (min-width: 769px) {
      .sidebar-layout {
        display: flex !important;
        flex-direction: row !important;
        align-items: flex-start !important;
        gap: 16px !important;
        width: 100% !important;
        flex-wrap: nowrap !important;
        margin-bottom: 12px !important;
      }
      
      .sidebar-layout > div:first-child {
        flex: 2 1 auto !important;
        min-width: 0 !important;
        width: auto !important;
      }
      
      .sidebar-layout > div:last-child {
        flex: 0 0 250px !important;
        min-width: 250px !important;
        max-width: 350px !important;
        width: auto !important;
      }
    }
    
    
    /* Emergency override - kill any column direction */
    .sidebar-layout {
      flex-direction: row !important;
    }
    
    </style>
    
    
    <!-- Mobile responsive styles moved to style-retro.css -->
    <!-- <style>
    /* Mobile responsive menu - only apply on small screens with strict conditions */
    @media (max-width: 768px) and (orientation: portrait),
           (max-width: 480px) {
      
      /* Create mobile layout container */
      body {
        display: flex !important;
        flex-direction: row !important;
        align-items: flex-start !important;
        min-height: 100vh !important;
      }
      
      /* Mobile navigation sidebar - left 12% of screen */
      .menu-bar {
        position: static !important;
        width: 12% !important;
        min-width: 80px !important;
        max-width: 120px !important;
        display: flex !important;
        flex-direction: column !important;
        background: #C0C0C0 !important;
        border: 2px solid #808080 !important;
        padding: 4px !important;
        margin: 8px 2px 8px 8px !important;
        box-sizing: border-box !important;
        flex-shrink: 0 !important;
      }
      
      /* Stack menu items vertically */
      .menu-dropdown {
        width: 100% !important;
        margin-bottom: 4px !important;
        display: block !important;
      }
      
      /* Adjust menu item appearance for mobile */
      .menu-item {
        display: block !important;
        width: 100% !important;
        padding: 2px 4px !important;
        background: #E0E0E0 !important;
        border: 1px solid #808080 !important;
        text-align: left !important;
        font-size: 8px !important;
        margin-bottom: 1px !important;
        word-wrap: break-word !important;
        white-space: normal !important;
        line-height: 1.0 !important;
      }
      
      /* Menu content positioning for mobile */
      .menu-content {
        position: relative !important;
        display: none !important;
        background: #F0F0F0 !important;
        border: 1px solid #808080 !important;
        padding: 4px !important;
        width: 100% !important;
        box-shadow: none !important;
        z-index: 1000 !important;
      }
      
      /* Show menu content when hovering */
      .menu-dropdown:hover .menu-content {
        display: block !important;
      }
      
      /* Menu links styling for mobile */
      .menu-content a {
        display: block !important;
        padding: 3px 4px !important;
        font-size: 7px !important;
        border-bottom: 1px dotted #C0C0C0 !important;
        text-decoration: none !important;
        color: #000 !important;
        word-wrap: break-word !important;
        white-space: normal !important;
      }
      
      .menu-content a:hover {
        background: #D0D0D0 !important;
      }
      
      .menu-content a:last-child {
        border-bottom: none !important;
      }
      
      /* External links section - below menu bar in same column */
      .external-links-section {
        position: static !important;
        width: 12% !important;
        min-width: 80px !important;
        max-width: 120px !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: stretch !important;
        padding: 4px !important;
        background: #F8F8F8 !important;
        border: 1px solid #C0C0C0 !important;
        margin: 0 2px 8px 8px !important;
        box-sizing: border-box !important;
        flex-shrink: 0 !important;
      }
      
      /* External link containers */
      .external-link-container {
        width: 100% !important;
        margin-bottom: 8px !important;
        text-align: center !important;
      }
      
      /* External link buttons */
      .external-link-btn {
        width: 100% !important;
        padding: 4px 2px !important;
        font-size: 7px !important;
        display: block !important;
        word-wrap: break-word !important;
        white-space: normal !important;
        line-height: 1.0 !important;
      }
      
      /* Button descriptions */
      .btn-description {
        font-size: 6px !important;
        margin-top: 1px !important;
        line-height: 1.0 !important;
      }
      
      /* Container for menu and external links */
      .mobile-sidebar {
        display: flex !important;
        flex-direction: column !important;
        width: 12% !important;
        min-width: 80px !important;
        max-width: 120px !important;
        flex-shrink: 0 !important;
      }
      
      /* Main content area - use remaining 85%+ space */
      .main-content {
        flex: 1 !important;
        width: 88% !important;
        padding: 8px !important;
        margin: 8px 8px 8px 4px !important;
        box-sizing: border-box !important;
        min-width: 0 !important;
      }
      
      /* Hide tool palette on mobile as it's not touch-friendly */
      .tool-palette {
        display: none !important;
      }
    }
    
    /* Very small screens - more compact */
    @media (max-width: 480px) {
      .menu-bar,
      .external-links-section,
      .mobile-sidebar {
        width: 15% !important;
        min-width: 70px !important;
        max-width: 100px !important;
      }
      
      .menu-item {
        padding: 4px 4px !important;
        font-size: 10px !important;
      }
      
      .menu-content a {
        padding: 4px 4px !important;
        font-size: 8px !important;
      }
      
      .external-link-btn {
        padding: 4px 2px !important;
        font-size: 9px !important;
      }
      
      .btn-description {
        font-size: 7px !important;
      }
      
      .main-content {
        width: 85% !important;
        padding: 4px !important;
        margin: 4px 4px 4px 2px !important;
      }
    }
    </style> -->
</head>
<body class="font-{{ get_current_font() }}">
  <!-- Mobile Top Menu Bar (horizontal layout) -->
  <div class="mobile-top-menu">
    <div class="mobile-menu-btn" id="mobile-file-menu">File</div>
    <div class="mobile-menu-btn" id="mobile-quiz-menu">Quiz</div>
    <div class="mobile-menu-btn" id="mobile-help-menu">Help</div>
    <div class="mobile-menu-btn" id="mobile-support-menu">Support</div>
    <a href="{{ url_for('blog.blog_index') }}" class="mobile-menu-btn" id="mobile-blog-menu">Blog</a>
  </div>

  <!-- Mobile container wrapper -->
  <div class="mobile-container">
    <!-- Left sidebar for mobile -->
    <div class="left-sidebar">
  <!-- Top Menu Bar (like Adobe Illustrator 1987) -->
  <div class="menu-bar">
    <div class="menu-dropdown">
      <span class="menu-item">{{ _('file') }}</span>
      <div class="menu-content">
        <a href="{{ url_for('home') }}">{{ _('home') }}</a>
        {% if current_user.is_authenticated %}
          <a href="{{ url_for('logout') }}">{{ _('logout') }}</a>
        {% else %}
          <a href="{{ url_for('login') }}">{{ _('login') }}</a>
        {% endif %}
      </div>
    </div>
    
    <div class="menu-dropdown">
      <span class="menu-item">{{ _('quiz') }}</span>
      <div class="menu-content">
        <a href="{{ url_for('grammar.grammar_index') }}">{{ _('grammar') }}</a>
        <a href="{{ url_for('vocab.vocab_index') }}">{{ _('vocabulary') }}</a>
        <a href="{{ url_for('flashcard.flashcard_index') }}">{{ _('flashcards') }}</a>
        <div class="menu-dropdown" style="position: relative;">
          <a href="#" style="display: block; padding: 2px 8px; color: #000000; text-decoration: none; font-size: 9px; border-bottom: 1px dotted #C0C0C0;">{{ _('akinator') }}</a>
          <div class="menu-content" style="position: absolute; left: 100%; top: 0; margin-left: 2px; display: none;">
            <a href="{{ url_for('akinator.akinator_index') }}?role=user">{{ _('you_are_akinator') }}</a>
            <a href="{{ url_for('akinator.akinator_index') }}?role=gpt">{{ _('ai_is_akinator') }}</a>
          </div>
        </div>
        <a href="{{ url_for('youtube_listening.listening_levels') }}">{{ _('youtube_listening') }}</a>
      </div>
    </div>
    
    <div class="menu-dropdown">
      <span class="menu-item">{{ _('help') }}</span>
      <div class="menu-content">
        <a href="{{ url_for('about') }}">{{ _('about') }}</a>
        <a href="#" id="settings-menu-link">{{ _('settings') }}</a>
        {% if current_user.is_authenticated and current_user.is_admin %}
        <a href="{{ url_for('admin_dashboard') }}">{{ _('admin_dashboard') }}</a>
        {% endif %}
      </div>
    </div>
    
    <div class="menu-dropdown">
      <span class="menu-item">{{ _('support_menu') }}</span>
      <div class="menu-content">
        <a href="https://www.patreon.com/japanesewithb" target="_blank">{{ _('patreon_support') }}</a>
        <a href="{{ url_for('donation') }}">{{ _('donation_page') }}</a>
      </div>
    </div>
    
    <div class="menu-dropdown">
      <a href="{{ url_for('blog.blog_index') }}" class="menu-item">{{ _('blog') }}</a>
    </div>
    
  </div>


  <!-- Left Tool Palette -->
  <div class="tool-palette">
    <div class="tool-icon" id="language-tool" title="{{ _('language_selection') }}">üåê</div>
    <div class="tool-icon" id="font-tool" title="{{ _('select_font') }}">A</div>
    {% if current_user.is_authenticated and current_user.auth_type != 'guest' %}
    <div class="tool-icon" id="feedback-tool" title="{{ _('feedback_tool') }}">‚úã</div>
    {% endif %}
    <div class="tool-icon" id="sitemap-tool" title="{{ _('sitemap_tool') }}">üîç</div>
  </div>

  <!-- External Links Section Below Tool Palette -->
  <div class="external-links-section">
    <!-- Preply Button -->
    <div class="external-link-container">
      <a href="https://preply.com/en/?pref=MTM4ODQxODM=&id=1754630335.010799&ep=w1" target="_blank" class="external-link-btn preply-btn">
        <div class="btn-text">Preply</div>
      </a>
      <div class="btn-description">Get 30% off coupon for the trial lesson!</div>
    </div>
    
    <!-- Patreon Button -->
    <div class="external-link-container">
      <a href="https://www.patreon.com/japanesewithb" target="_blank" class="external-link-btn patreon-btn">
        <div class="btn-text">Patreon</div>
      </a>
      <div class="btn-description">Support ongoing development</div>
    </div>
  </div>

    </div> <!-- Close left-sidebar -->
    
    <!-- Main content wrapper -->
    <div class="content-wrapper">

  <!-- Main Content Window -->
  <div class="main-content-wrapper">
    <div class="window">
      <div class="title-bar">
        {% block window_title %}{{ _('japanese_learning_app') }}{% endblock %}
      </div>
      <div class="main-content">
        <div class="sidebar-layout" style="display: flex !important; flex-direction: row !important; align-items: flex-start !important; gap: 16px; margin-bottom: 12px; width: 100% !important;">
          <!-- Left side - Main content -->
          <div style="flex: 2 !important; min-width: 0 !important;">
            {% block content %}{% endblock %}
          </div>
          
          <!-- Right side - Sidebar -->
          <div style="flex: 1 !important; min-width: 200px !important; max-width: 300px !important;">
            <!-- Debug: Direct sidebar content instead of include -->
            <!-- Recommended Practice Section -->
            <div style="border: 1px solid #000; padding: 8px; background: #F8F8F8; margin-bottom: 12px;">
              <h3 style="margin-bottom: 8px; font-size: 11px; text-align: center;">{{ _('recommended_practice') }}</h3>
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <a href="{{ url_for('grammar.grammar_index') }}" 
                   style="display: block; padding: 6px; background: #E0E0E0; text-decoration: none; color: #000; font-size: 9px; text-align: center; border: 1px solid #999;">
                  {{ _('grammar') }}
                </a>
                <a href="{{ url_for('youtube_listening.listening_levels') }}" 
                   style="display: block; padding: 6px; background: #E0E0E0; text-decoration: none; color: #000; font-size: 9px; text-align: center; border: 1px solid #999;">
                  {{ _('youtube_listening') }}
                </a>
                <a href="{{ url_for('akinator.akinator_index', role='user') }}" 
                   style="display: block; padding: 6px; background: #E0E0E0; text-decoration: none; color: #000; font-size: 9px; text-align: center; border: 1px solid #999;">
                  {{ _('akinator') }}
                </a>
              </div>
            </div>
            
            <!-- Latest Blog Posts Section -->
            <div style="border: 1px solid #000; padding: 8px; background: #F0F8F0;">
              <h3 style="margin-bottom: 8px; font-size: 11px; text-align: center;">Latest Blog</h3>
              <div style="display: flex; flex-direction: column; gap: 4px;" id="blog-posts-container">
                <!-- Blog posts will be loaded via JavaScript -->
                <div style="font-size: 8px; color: #666; text-align: center; padding: 4px;">
                  Loading blog posts...
                </div>
              </div>
            </div>

            <script>
            // Load latest blog posts
            fetch('/blog/api/latest')
              .then(response => response.json())
              .then(posts => {
                const container = document.getElementById('blog-posts-container');
                if (posts.length === 0) {
                  container.innerHTML = '<div style="font-size: 8px; color: #666; text-align: center; padding: 4px;">No blog posts available</div>';
                  return;
                }
                
                container.innerHTML = posts.map(post => 
                  '<a href="/blog/post/' + post.document_id + '" ' +
                     'style="display: block; padding: 4px; background: #E8E8E8; text-decoration: none; color: #000; font-size: 8px; text-align: left; border: 1px solid #CCC; line-height: 1.2;" ' +
                     'title="' + post.title + '">' +
                    (post.title.length > 30 ? post.title.substring(0, 30) + '...' : post.title) +
                  '</a>'
                ).join('');
              })
              .catch(error => {
                console.log('Blog posts loading failed:', error);
                const container = document.getElementById('blog-posts-container');
                container.innerHTML = '<div style="font-size: 8px; color: #666; text-align: center; padding: 4px;">Blog posts unavailable</div>';
              });
            </script>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Loading Indicator -->
  <div id="global-loading" class="global-loading" style="display: none;">
    <div class="loading-content">
      <div class="retro-spinner"></div>
      <div class="loading-text">Processing...</div>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="status-bar">
    <span>{{ _('ready') }}</span>
    <span style="margin-left: auto;">
      {% if current_user.is_authenticated %}
        {{ _('user') }}: {{ current_user.username }}
      {% else %}
        {{ _('not_logged_in') }}
      {% endif %}
    </span>
  </div>

  <!-- Footer -->
  <div class="footer-copyright">
    {{ _('copyright') }}
  </div>
    </div> <!-- Close content-wrapper -->
  </div> <!-- Close mobile-container -->

  <!-- Mobile Bottom Toolbar (positioned outside containers to avoid hiding) -->
  <div class="mobile-bottom-toolbar">
    <!-- Language Tool -->
    <div class="mobile-tool-btn" id="mobile-language-tool" title="{{ _('language_selection') }}">üåê</div>
    <!-- Font Tool -->
    <div class="mobile-tool-btn" id="mobile-font-tool" title="{{ _('select_font') }}">A</div>
    <!-- Feedback Tool -->
    {% if current_user.is_authenticated and current_user.auth_type != 'guest' %}
    <div class="mobile-tool-btn" id="mobile-feedback-tool" title="{{ _('feedback_tool') }}">üñêÔ∏è</div>
    {% endif %}
    <!-- Sitemap Tool -->
    <div class="mobile-tool-btn" id="mobile-sitemap-tool" title="{{ _('sitemap_tool') }}">üîç</div>
    <!-- Preply Button -->
    <a href="https://preply.com/en/?pref=MTM4ODQxODM=&id=1754630335.010799&ep=w1" target="_blank" class="mobile-tool-btn mobile-text-btn" title="Preply">Preply</a>
    <!-- Patreon Button -->
    <a href="https://www.patreon.com/japanesewithb" target="_blank" class="mobile-tool-btn mobile-text-btn" title="Patreon">Patreon</a>
  </div>

  <!-- Global Popup Modals (Outside all containers for proper z-index) -->
  <!-- Feedback Popup Modal -->
  <div id="feedback-modal" class="feedback-modal">
    <div class="feedback-window">
      <div class="feedback-title-bar">
        <span>{{ _('feedback') }}</span>
        <button id="feedback-close" class="feedback-close-btn">√ó</button>
      </div>
      <div class="feedback-content">
        <form id="feedback-form" method="POST" action="/feedback">
          <!-- Privacy Notice -->
          <div style="margin-bottom: 8px; padding: 6px; background: #f0f8ff; border: 1px solid #cce7f0; font-size: 7px; color: #2c5282; line-height: 1.2;">
            ‚ÑπÔ∏è {{ _('feedback_privacy_notice') }}
          </div>
          <div class="feedback-field">
            <label>{{ _('message') }}:</label>
            <textarea name="message" id="feedback-message" rows="8" required placeholder="{{ _('feedback_placeholder') }}"></textarea>
          </div>
          <div class="feedback-buttons">
            <button type="submit" class="feedback-btn-submit">{{ _('send') }}</button>
            <button type="button" id="feedback-cancel" class="feedback-btn-cancel">{{ _('cancel') }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sitemap Popup Modal -->
  <div id="sitemap-modal" class="sitemap-modal">
    <div class="sitemap-window">
      <div class="sitemap-title-bar">
        <span>{{ _('sitemap_tool') }}</span>
        <button id="sitemap-close" class="sitemap-close-btn">√ó</button>
      </div>
      <div class="sitemap-content">
        <div id="sitemap-loading" style="text-align: center; padding: 20px; font-size: 10px;">
          {{ _('loading') }}
        </div>
        <div id="sitemap-data" style="display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Settings Popup Modal -->
  <div id="settings-modal" class="settings-modal">
    <div class="settings-window">
      <div class="settings-title-bar">
        <span>{{ _('settings') }}</span>
        <button id="settings-close" class="settings-close-btn">√ó</button>
      </div>
      <div class="settings-content">
        <div style="padding: 12px;">
          <!-- Language Setting -->
          <div class="settings-group">
            <h3 style="font-size: 11px; margin: 0 0 6px 0; font-weight: bold;">{{ _('language') }}</h3>
            <div class="settings-options">
              <button class="settings-btn" onclick="changeLanguage('en')">English</button>
              <button class="settings-btn" onclick="changeLanguage('ja')">Êó•Êú¨Ë™û</button>
              <button class="settings-btn" onclick="changeLanguage('es')">Espa√±ol</button>
            </div>
          </div>
          
          <!-- Font Setting -->
          <div class="settings-group" style="margin-top: 16px;">
            <h3 style="font-size: 11px; margin: 0 0 6px 0; font-weight: bold;">{{ _('font') }}</h3>
            <div class="settings-options">
              <button class="settings-btn" onclick="changeFont('notosans')">Noto Sans JP (Modern)</button>
              <button class="settings-btn" onclick="changeFont('dotgothic')">DotGothic16 (Pixel)</button>
              <button class="settings-btn" onclick="changeFont('klee')">Klee One (Textbook)</button>
            </div>
          </div>
          
          <!-- Toolbar Note -->
          <div style="margin-top: 16px; padding: 6px; background: #F0F0F0; border: 1px solid #808080; font-size: 8px; color: #404040;">
            üí° {{ _('settings_toolbar_note') }}
          </div>
        </div>
      </div>
    </div>
  </div>


  {% block scripts %}{% endblock %}

  <script>
    // Simple tool palette interaction (desktop)
    document.querySelectorAll('.tool-icon').forEach(tool => {
      tool.addEventListener('click', function() {
        // Special handling for feedback tool
        if (this.id === 'feedback-tool') {
          // Check if user is logged in by looking for login/logout links in menu
          const loginLink = document.querySelector('a[href*="login"]');
          const logoutLink = document.querySelector('a[href*="logout"]');
          const isLoggedIn = !loginLink || logoutLink;
          
          if (!isLoggedIn) {
            alert('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÄÅÊÑüÊÉ≥„ÇíÈÄÅ„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            window.location.href = '/login';
            return;
          }
          const feedbackModal = document.getElementById('feedback-modal');
          feedbackModal.classList.add('modal-show');
          return;
        }
        
        // Special handling for sitemap tool
        if (this.id === 'sitemap-tool') {
          loadSitemap();
          return;
        }
        
        // Special handling for language tool
        if (this.id === 'language-tool') {
          showLanguageMenu(this);
          return;
        }
        
        // Special handling for font tool
        if (this.id === 'font-tool') {
          showFontMenu(this);
          return;
        }
        
        
        document.querySelectorAll('.tool-icon').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
      });
    });
    
    // Set selection tool as default active
    if (document.querySelector('.tool-icon')) {
      document.querySelector('.tool-icon').classList.add('active');
    }

    // Mobile tool palette interaction
    document.querySelectorAll('.mobile-tool-btn').forEach(tool => {
      tool.addEventListener('click', function(e) {
        // Don't prevent default for link buttons (Preply, Patreon)
        if (this.tagName.toLowerCase() === 'a') {
          return; // Let the link work normally
        }
        
        e.preventDefault();
        
        // Special handling for mobile feedback tool
        if (this.id === 'mobile-feedback-tool') {
          e.stopPropagation();
          const loginLink = document.querySelector('a[href*="login"]');
          const logoutLink = document.querySelector('a[href*="logout"]');
          const isLoggedIn = !loginLink || logoutLink;
          
          if (!isLoggedIn) {
            alert('„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÄÅÊÑüÊÉ≥„ÇíÈÄÅ„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            window.location.href = '/login';
            return;
          }
          
          // Show feedback modal with standard class approach
          const feedbackModal = document.getElementById('feedback-modal');
          if (feedbackModal) {
            feedbackModal.classList.add('modal-show');
          } else {
          }
          return;
        }
        
        // Special handling for mobile sitemap tool
        if (this.id === 'mobile-sitemap-tool') {
          e.stopPropagation();
          loadSitemap();
          return;
        }
        
        // Special handling for mobile language tool
        if (this.id === 'mobile-language-tool') {
          e.stopPropagation();
          showMobileLanguageMenu(this);
          return;
        }
        
        // Special handling for mobile font tool
        if (this.id === 'mobile-font-tool') {
          e.stopPropagation();
          showMobileFontMenu(this);
          return;
        }
        
        
        // For link buttons (Preply, Patreon), don't prevent default to allow navigation
      });
    });

    // Mobile top menu interaction
    document.querySelectorAll('.mobile-menu-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        // If this is a link button (like Blog), let it navigate normally
        if (this.tagName.toLowerCase() === 'a') {
          return; // Let the link work normally
        }
        
        // For dropdown buttons, show corresponding menu from desktop version
        let targetMenu = null;
        const allMenus = document.querySelectorAll('.menu-bar > .menu-dropdown');
        
        // Map by button text to menu content
        if (this.id === 'mobile-file-menu') {
          // Find File menu - first menu dropdown
          targetMenu = allMenus[0]?.querySelector('.menu-content');
        } else if (this.id === 'mobile-quiz-menu') {
          // Find Quiz menu - second menu dropdown  
          targetMenu = allMenus[1]?.querySelector('.menu-content');
        } else if (this.id === 'mobile-help-menu') {
          // Find Help menu - third menu dropdown
          targetMenu = allMenus[2]?.querySelector('.menu-content');
        } else if (this.id === 'mobile-support-menu') {
          // Find Support menu - fourth menu dropdown
          targetMenu = allMenus[3]?.querySelector('.menu-content');
        }
        
        if (targetMenu) {
          showMobileDropdown(null, this, targetMenu);
        }
      });
    });

    // Show mobile dropdown menu
    function showMobileDropdown(selector, triggerBtn, sourceMenu = null) {
      // Remove any existing dropdown
      const existing = document.querySelector('.mobile-dropdown-menu');
      if (existing) existing.remove();
      
      // Use passed sourceMenu or find by selector
      if (!sourceMenu) {
        sourceMenu = document.querySelector(selector);
      }
      if (!sourceMenu) return;
      
      const dropdown = document.createElement('div');
      dropdown.className = 'mobile-dropdown-menu';
      dropdown.innerHTML = sourceMenu.innerHTML;
      
      // Re-attach event listeners for copied elements
      const copiedSettingsLink = dropdown.querySelector('#settings-menu-link');
      if (copiedSettingsLink) {
        copiedSettingsLink.addEventListener('click', function(e) {
          e.preventDefault();
          // Close the mobile dropdown first
          dropdown.remove();
          // Open settings modal directly
          const settingsModal = document.getElementById('settings-modal');
          if (settingsModal) {
            settingsModal.classList.add('modal-show');
          }
        });
      }
      
      dropdown.style.position = 'fixed';
      dropdown.style.top = '60px'; // Below top menu
      dropdown.style.left = '50%';
      dropdown.style.transform = 'translateX(-50%)';
      dropdown.style.backgroundColor = '#C0C0C0';
      dropdown.style.border = '2px outset #C0C0C0';
      dropdown.style.padding = '8px';
      dropdown.style.fontSize = '12px';
      dropdown.style.zIndex = '11000';
      dropdown.style.minWidth = '150px';
      dropdown.style.maxWidth = '300px';
      dropdown.style.textAlign = 'left';
      
      document.body.appendChild(dropdown);
      
      // Close dropdown when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMobileDropdown(e) {
          if (!dropdown.contains(e.target) && e.target !== triggerBtn) {
            dropdown.remove();
            document.removeEventListener('click', closeMobileDropdown);
          }
        });
      }, 100);
    }

    // Force mobile toolbar display ONLY on actual mobile devices
    function checkMobileAndShowToolbar() {
      const screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
      const isNarrowScreen = screenWidth <= 768;
      const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      // Show on mobile devices OR narrow screens (for testing)
      const isMobile = isMobileUA || isTouchDevice || isNarrowScreen;
      
      const bottomToolbar = document.querySelector('.mobile-bottom-toolbar');
      const topMenu = document.querySelector('.mobile-top-menu');
      
      
      // Only show on actual mobile devices
      if (isMobile) {
        if (bottomToolbar) {
          try {
            // Remove all CSS classes temporarily to override any conflicting styles
            bottomToolbar.className = 'mobile-bottom-toolbar';
            
            // Force mobile display with maximum priority
            bottomToolbar.style.cssText = `
              display: flex !important;
              visibility: visible !important;
              opacity: 1 !important;
              position: fixed !important;
              bottom: 0px !important;
              left: 0 !important;
              right: 0 !important;
              width: 100% !important;
              height: 60px !important;
              z-index: 99999 !important;
              background-color: #C0C0C0 !important;
              border-top: 2px solid #808080 !important;
              justify-content: stretch !important;
              align-items: stretch !important;
              padding: 6px 4px !important;
              box-sizing: border-box !important;
              overflow: visible !important;
              top: auto !important;
              box-shadow: 0 -1px 2px rgba(0,0,0,0.2) !important;
              gap: 2px !important;
            `;
          } catch (e) {
          }
        } else {
        }
        
        if (topMenu) {
          try {
            // Force mobile top menu display
            topMenu.style.cssText = `
              display: flex !important;
              visibility: visible !important;
              opacity: 1 !important;
              position: fixed !important;
              top: 0 !important;
              left: 0 !important;
              right: 0 !important;
              width: 100% !important;
              height: 50px !important;
              z-index: 10002 !important;
              background-color: #C0C0C0 !important;
              border-bottom: 2px solid #808080 !important;
              justify-content: stretch !important;
              align-items: stretch !important;
              padding: 4px 4px !important;
              box-sizing: border-box !important;
              overflow: visible !important;
              bottom: auto !important;
              gap: 2px !important;
              box-shadow: 0 1px 2px rgba(0,0,0,0.2) !important;
            `;
          } catch (e) {
          }
        } else {
        }
      } else {
        // Force hide on non-mobile devices (PC/Desktop)
        if (bottomToolbar) {
          bottomToolbar.style.cssText = `
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            width: 0 !important;
            height: 0 !important;
            z-index: -1 !important;
            overflow: hidden !important;
          `;
        }
        if (topMenu) {
          topMenu.style.cssText = `
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            width: 0 !important;
            height: 0 !important;
            z-index: -1 !important;
            overflow: hidden !important;
          `;
        }
      }
    }
    
    // Run on load and resize
    window.addEventListener('load', checkMobileAndShowToolbar);
    window.addEventListener('resize', checkMobileAndShowToolbar);
    document.addEventListener('DOMContentLoaded', checkMobileAndShowToolbar);

    // Auto-hide/show toolbars on scroll
    let scrollTimeout;
    let lastScrollY = window.scrollY;
    let isScrolling = false;

    function handleScroll() {
      const currentScrollY = window.scrollY;
      const bottomToolbar = document.querySelector('.mobile-bottom-toolbar');
      const topMenu = document.querySelector('.mobile-top-menu');
      
      // Only apply on mobile screens
      const screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
      const isMobileScreen = screenWidth <= 768;
      
      if (!isMobileScreen || !bottomToolbar || !topMenu) return;
      
      isScrolling = true;
      
      // Show toolbars during scroll
      bottomToolbar.style.transform = 'translateY(0)';
      bottomToolbar.style.transition = 'transform 0.3s ease';
      topMenu.style.transform = 'translateY(0)';
      topMenu.style.transition = 'transform 0.3s ease';
      
      // Clear previous timeout
      clearTimeout(scrollTimeout);
      
      // Hide toolbars 2 seconds after scrolling stops
      scrollTimeout = setTimeout(() => {
        isScrolling = false;
        if (bottomToolbar && topMenu) {
          bottomToolbar.style.transform = 'translateY(100%)';
          topMenu.style.transform = 'translateY(-100%)';
        }
      }, 2000);
      
      lastScrollY = currentScrollY;
    }

    // Show toolbars on touch/mouse interaction
    function showToolbarsOnInteraction() {
      const bottomToolbar = document.querySelector('.mobile-bottom-toolbar');
      const topMenu = document.querySelector('.mobile-top-menu');
      
      if (bottomToolbar && topMenu) {
        bottomToolbar.style.transform = 'translateY(0)';
        topMenu.style.transform = 'translateY(0)';
        
        // Hide again after 3 seconds if not scrolling
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          if (!isScrolling) {
            bottomToolbar.style.transform = 'translateY(100%)';
            topMenu.style.transform = 'translateY(-100%)';
          }
        }, 3000);
      }
    }

    // Add scroll listener
    window.addEventListener('scroll', handleScroll, { passive: true });
    
    // Add interaction listeners for mobile
    document.addEventListener('touchstart', showToolbarsOnInteraction, { passive: true });
    document.addEventListener('touchmove', showToolbarsOnInteraction, { passive: true });
    document.addEventListener('mousemove', showToolbarsOnInteraction, { passive: true });

    // Initialize toolbars hidden state on mobile
    function initializeToolbarHiding() {
      const screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
      const isMobileScreen = screenWidth <= 768;
      
      if (isMobileScreen) {
        const bottomToolbar = document.querySelector('.mobile-bottom-toolbar');
        const topMenu = document.querySelector('.mobile-top-menu');
        
        if (bottomToolbar && topMenu) {
          // Hide toolbars initially
          setTimeout(() => {
            bottomToolbar.style.transition = 'transform 0.3s ease';
            topMenu.style.transition = 'transform 0.3s ease';
            bottomToolbar.style.transform = 'translateY(100%)';
            topMenu.style.transform = 'translateY(-100%)';
          }, 1000); // Wait 1 second before hiding
        }
      }
    }

    // Initialize hiding after everything is loaded
    window.addEventListener('load', initializeToolbarHiding);
    document.addEventListener('DOMContentLoaded', initializeToolbarHiding);

    
    // Feedback modal functionality
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('feedback-modal');
      const closeBtn = document.getElementById('feedback-close');
      const cancelBtn = document.getElementById('feedback-cancel');
      const form = document.getElementById('feedback-form');
      
      // Close modal functions
      function closeModal() {
        modal.classList.remove('modal-show');
        form.reset();
      }
      
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);
      
      // Close when clicking outside the window
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // Handle form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        fetch('/feedback', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('{{ _('feedback_success') }}');
            closeModal();
          } else {
            alert('{{ _('feedback_error') }}');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('{{ _('feedback_error') }}');
        });
      });
      
      // Sitemap modal functionality
      const sitemapModal = document.getElementById('sitemap-modal');
      const sitemapCloseBtn = document.getElementById('sitemap-close');
      
      // Close sitemap modal function
      function closeSitemapModal() {
        sitemapModal.classList.remove('modal-show');
      }
      
      sitemapCloseBtn.addEventListener('click', closeSitemapModal);
      
      // Close when clicking outside the window
      sitemapModal.addEventListener('click', function(e) {
        if (e.target === sitemapModal) {
          closeSitemapModal();
        }
      });

      // Settings modal functionality  
      const settingsModal = document.getElementById('settings-modal');
      const settingsCloseBtn = document.getElementById('settings-close');
      const settingsMenuLink = document.getElementById('settings-menu-link');
      
      
      // Open settings modal function  
      function openSettingsModal() {
        settingsModal.classList.add('modal-show');
      }
      
      // Close settings modal function
      function closeSettingsModal() {
        settingsModal.classList.remove('modal-show');
      }
      
      // Add event listener only if element exists
      if (settingsMenuLink) {
        settingsMenuLink.addEventListener('click', function(e) {
          e.preventDefault();
          openSettingsModal();
        });
      }
      
      settingsCloseBtn.addEventListener('click', closeSettingsModal);
      
      // Close when clicking outside the window
      settingsModal.addEventListener('click', function(e) {
        if (e.target === settingsModal) {
          closeSettingsModal();
        }
      });
      
      
      // PayPal button is now functional - no placeholder needed
    });
    
    // Load sitemap data
    function loadSitemap() {
      const modal = document.getElementById('sitemap-modal');
      const loading = document.getElementById('sitemap-loading');
      const dataDiv = document.getElementById('sitemap-data');
      
      if (!modal) {
        return;
      }
      
      // Show modal with standard class approach
      modal.classList.add('modal-show');
      
      if (loading) loading.style.display = 'block';
      if (dataDiv) dataDiv.style.display = 'none';
      
      fetch('/sitemap_data')
        .then(response => response.json())
        .then(data => {
          let html = '<div class="sitemap-md">';
          html += '<pre>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n';
          html += '‚îÇ              üó∫Ô∏è  SITEMAP                   ‚îÇ\n';
          html += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n';
          
          Object.keys(data).forEach((category, categoryIndex) => {
            if (data[category].length === 0) return;
            
            html += `## üìÅ ${category}\n`;
            html += '‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
            
            data[category].forEach((item, index) => {
              const isLast = index === data[category].length - 1;
              const prefix = isLast ? '‚îî‚îÄ‚îÄ' : '‚îú‚îÄ‚îÄ';
              html += `${prefix} <a href="${item.url}">[${item.name}]</a>\n`;
              html += `${isLast ? '    ' : '‚îÇ   '} ‚îî‚îÄ ${item.description}\n`;
            });
            
            html += '\n';
          });
          
          html += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
          html += 'üí° Tip: Click links to navigate to each page\n';
          html += '</pre></div>';
          
          dataDiv.innerHTML = html;
          loading.style.display = 'none';
          dataDiv.style.display = 'block';
        })
        .catch(error => {
          console.error('Error loading sitemap:', error);
          dataDiv.innerHTML = '<p style="text-align: center; color: #FF0000; font-size: 10px;">Failed to load sitemap</p>';
          loading.style.display = 'none';
          dataDiv.style.display = 'block';
        });
    }
    
    // Language menu functionality
    let languageMenuOpen = false;
    
    function showLanguageMenu(toolElement) {
      // Remove any existing language menu
      const existingMenu = document.querySelector('.language-menu');
      if (existingMenu) {
        existingMenu.remove();
        languageMenuOpen = false;
        return;
      }
      
      const menu = document.createElement('div');
      menu.className = 'language-menu';
      menu.innerHTML = `
        <div class="language-option" onclick="changeLanguage('en')">English</div>
        <div class="language-option" onclick="changeLanguage('ja')">Êó•Êú¨Ë™û</div>
        <div class="language-option" onclick="changeLanguage('es')">Espa√±ol</div>
      `;
      
      const rect = toolElement.getBoundingClientRect();
      menu.style.position = 'fixed';
      menu.style.left = (rect.right + 5) + 'px';
      menu.style.top = rect.top + 'px';
      menu.style.backgroundColor = '#C0C0C0';
      menu.style.border = '2px outset #C0C0C0';
      menu.style.padding = '2px';
      menu.style.fontSize = '10px';
      menu.style.zIndex = '11000';
      menu.style.minWidth = '80px';
      
      document.body.appendChild(menu);
      languageMenuOpen = true;
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeLanguageMenu(e) {
          if (!menu.contains(e.target) && e.target !== toolElement) {
            menu.remove();
            languageMenuOpen = false;
            document.removeEventListener('click', closeLanguageMenu);
          }
        });
      }, 100);
    }
    
    // Language switching function
    function changeLanguage(langCode) {
      // Remove language menu
      const menu = document.querySelector('.language-menu');
      if (menu) menu.remove();
      
      fetch('/language', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({language: langCode})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Reload current page instead of going to home
          window.location.reload();
        } else {
          alert('Failed to change language');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error changing language');
      });
    }

    // Font menu functionality
    let fontMenuOpen = false;
    
    function showFontMenu(toolElement) {
      // Remove any existing font menu
      const existingMenu = document.querySelector('.font-menu');
      if (existingMenu) {
        existingMenu.remove();
        fontMenuOpen = false;
        return;
      }
      
      const menu = document.createElement('div');
      menu.className = 'font-menu';
      menu.innerHTML = `
        <div class="font-option" onclick="changeFont('notosans')">Noto Sans JP (Modern)</div>
        <div class="font-option" onclick="changeFont('dotgothic')">DotGothic16 (Pixel)</div>
        <div class="font-option" onclick="changeFont('klee')">Klee One (Textbook)</div>
      `;
      
      const rect = toolElement.getBoundingClientRect();
      menu.style.position = 'fixed';
      menu.style.left = (rect.right + 5) + 'px';
      menu.style.top = rect.top + 'px';
      menu.style.backgroundColor = '#C0C0C0';
      menu.style.border = '2px outset #C0C0C0';
      menu.style.padding = '2px';
      menu.style.fontSize = '10px';
      menu.style.zIndex = '11000';
      menu.style.minWidth = '120px';
      
      document.body.appendChild(menu);
      fontMenuOpen = true;
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeFontMenu(e) {
          if (!menu.contains(e.target) && e.target !== toolElement) {
            menu.remove();
            fontMenuOpen = false;
            document.removeEventListener('click', closeFontMenu);
          }
        });
      }, 100);
    }
    
    // Font switching function
    function changeFont(fontFamily) {
      // Remove font menu
      const menu = document.querySelector('.font-menu');
      if (menu) menu.remove();
      
      fetch('/font', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({font_family: fontFamily})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Apply font immediately without reload
          document.body.className = document.body.className.replace(/font-\w+/g, '');
          document.body.classList.add('font-' + fontFamily);
        } else {
          alert('Failed to change font');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error changing font');
      });
    }
    
    // Global Loading Indicator Functions
    window.showLoading = function(message = 'Processing...') {
      const loadingEl = document.getElementById('global-loading');
      const textEl = loadingEl.querySelector('.loading-text');
      textEl.textContent = message;
      loadingEl.style.display = 'flex';
    };
    
    window.hideLoading = function() {
      const loadingEl = document.getElementById('global-loading');
      loadingEl.style.display = 'none';
    };
    
    // Auto-show loading for form submissions and page navigation
    document.addEventListener('DOMContentLoaded', function() {
      const forms = document.querySelectorAll('form');
      forms.forEach(form => {
        form.addEventListener('submit', function(e) {
          // Show loading for all form submissions
          const hasAI = form.classList.contains('ai-form') || 
                       form.querySelector('[name="question"]') || 
                       form.querySelector('[name="answer"]') ||
                       form.querySelector('[name="translation"]');
          
          if (hasAI) {
            showLoading('AI is thinking...');
          } else {
            showLoading('Loading...');
          }
        });
      });
      
      // Show loading for navigation links that might take time
      const links = document.querySelectorAll('a[href]:not([href^="#"]):not([href^="mailto:"]):not([href^="javascript:"]):not([target="_blank"])');
      links.forEach(link => {
        link.addEventListener('click', function(e) {
          // Skip if it's a sort/filter link (quick operations)
          if (this.classList.contains('sort-link') || 
              this.classList.contains('filter-btn') || 
              this.href.includes('sort=') ||
              this.href.includes('level=')) {
            return;
          }
          showLoading('Loading...');
        });
      });
    });

    // Mobile Language menu functionality
    let mobileLanguageMenuOpen = false;
    
    function showMobileLanguageMenu(toolElement) {
      // Remove any existing language menu
      const existingMenu = document.querySelector('.mobile-language-menu');
      if (existingMenu) {
        existingMenu.remove();
        mobileLanguageMenuOpen = false;
        return;
      }
      
      const menu = document.createElement('div');
      menu.className = 'mobile-language-menu';
      menu.innerHTML = `
        <div class="mobile-language-option" onclick="changeLanguage('en')">English</div>
        <div class="mobile-language-option" onclick="changeLanguage('ja')">Êó•Êú¨Ë™û</div>
        <div class="mobile-language-option" onclick="changeLanguage('es')">Espa√±ol</div>
      `;
      
      menu.style.position = 'fixed';
      menu.style.bottom = '100px';
      menu.style.left = '50%';
      menu.style.transform = 'translateX(-50%)';
      menu.style.backgroundColor = '#C0C0C0';
      menu.style.border = '2px outset #C0C0C0';
      menu.style.padding = '8px';
      menu.style.fontSize = '14px';
      menu.style.zIndex = '11000';
      menu.style.minWidth = '120px';
      menu.style.textAlign = 'center';
      
      document.body.appendChild(menu);
      mobileLanguageMenuOpen = true;
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMobileLanguageMenu(e) {
          if (!menu.contains(e.target) && e.target !== toolElement) {
            menu.remove();
            mobileLanguageMenuOpen = false;
            document.removeEventListener('click', closeMobileLanguageMenu);
          }
        });
      }, 100);
    }

    // Mobile Font menu functionality
    let mobileFontMenuOpen = false;
    
    function showMobileFontMenu(toolElement) {
      // Remove any existing font menu
      const existingMenu = document.querySelector('.mobile-font-menu');
      if (existingMenu) {
        existingMenu.remove();
        mobileFontMenuOpen = false;
        return;
      }
      
      const menu = document.createElement('div');
      menu.className = 'mobile-font-menu';
      menu.innerHTML = `
        <div class="mobile-font-option" onclick="changeFont('notosans')">Noto Sans JP (Modern)</div>
        <div class="mobile-font-option" onclick="changeFont('dotgothic')">DotGothic16 (Pixel)</div>
        <div class="mobile-font-option" onclick="changeFont('klee')">Klee One (Textbook)</div>
      `;
      
      menu.style.position = 'fixed';
      menu.style.bottom = '100px';
      menu.style.left = '50%';
      menu.style.transform = 'translateX(-50%)';
      menu.style.backgroundColor = '#C0C0C0';
      menu.style.border = '2px outset #C0C0C0';
      menu.style.padding = '8px';
      menu.style.fontSize = '14px';
      menu.style.zIndex = '11000';
      menu.style.minWidth = '200px';
      menu.style.textAlign = 'center';
      
      document.body.appendChild(menu);
      mobileFontMenuOpen = true;
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMobileFontMenu(e) {
          if (!menu.contains(e.target) && e.target !== toolElement) {
            menu.remove();
            mobileFontMenuOpen = false;
            document.removeEventListener('click', closeMobileFontMenu);
          }
        });
      }, 100);
    }
    
    // Prevent Akinator parent link from navigating
    document.addEventListener('DOMContentLoaded', function() {
      const akinatorLink = document.querySelector('.menu-content .menu-dropdown > a[href="#"]');
      if (akinatorLink) {
        akinatorLink.addEventListener('click', function(e) {
          e.preventDefault();
          return false;
        });
      }
    });
  </script>

  <style>
    /* Fix for nested menu dropdown (Akinator submenu) */
    .menu-content .menu-dropdown {
      position: relative;
    }
    
    .menu-content .menu-dropdown:hover .menu-content {
      display: block !important;
      position: absolute;
      left: 100%;
      top: 0;
      margin-left: 2px;
      z-index: 12002;
    }
    
    /* Prevent Akinator parent link from navigating */
    .menu-content .menu-dropdown > a[href="#"] {
      cursor: pointer;
    }
    
    .menu-content .menu-dropdown > a[href="#"]:hover {
      background-color: #000000;
      color: #FFFFFF;
    }
  </style>
</body>
</html>