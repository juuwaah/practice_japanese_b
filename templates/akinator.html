{% extends "base.html" %}

{% block title %}{{ _('akinator_game') }} - {{ _('japanese_learning_app') }}{% endblock %}

{% block window_title %}JLPT {{ _('word_akinator') }}{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='speech-recognition.js') }}"></script>
{% endblock %}

{% block content %}
    <div style="text-align: center; margin-bottom: 12px;">
      <h1>{{ _('word_akinator') }}</h1>
      <div style="text-align: right;">
        <a href="{{ url_for('akinator.akinator_index') }}" 
           style="font-size: 8px; background: #F0F0F0; border: 1px solid #000; padding: 2px 6px; text-decoration: none;">
          {{ _('reset_change') }}
        </a>
      </div>
    </div>

<div style="border: 2px solid #000; padding: 8px; margin-bottom: 12px; background: #F8F8F8; 
            min-height: 120px; max-height: 180px; overflow-y: auto;">
  <div style="font-size: 9px; font-weight: bold; margin-bottom: 4px; text-decoration: underline;">
    {{ _('conversation') }}:
  </div>
  
  {% for msg in history %}
    <div style="margin-bottom: 6px; padding: 4px; border: 1px dotted #808080; 
                background: {% if msg['role']=='user' %}#FFFFFF{% else %}#F0F0F0{% endif %};">
      <div style="font-size: 8px; font-weight: bold; margin-bottom: 2px;">
        {% if msg['role']=='user' %}{{ _('you') }}:{% else %}{{ _('ai') }}:{% endif %}
      </div>
      <div style="font-size: 9px;">{{ msg['text'] }}</div>
    </div>
  {% endfor %}
</div>

{% if not gameover %}
  {% if role == 'user' %}
    <div style="border: 1px solid #000; padding: 8px; background: #F0F0F0;">
      <form id="chat-form" method="post" action="">
        <div style="margin-bottom: 8px; display: flex; gap: 4px; align-items: center;">
          <input type="text" name="message" id="message" 
                 placeholder="{{ _('type_your_question') }}" 
                 style="flex: 1; padding: 2px 4px; font-size: 9px; border: 1px solid #000; box-sizing: border-box;">
          <div id="voice-input-message"></div>
        </div>
        
        <div style="display: flex; gap: 4px;">
          <button type="submit" style="flex: 1; padding: 4px; font-size: 8px; font-weight: bold;">
            {{ _('submit_press_enter') }}
          </button>
          <button type="button" id="hint-btn" 
                  style="flex: 1; padding: 4px; font-size: 8px; background: #E0E0E0;">
            {{ _('hint') }}
          </button>
          <button type="button" id="giveup-btn" 
                  style="flex: 1; padding: 4px; font-size: 8px; background: #D0D0D0;">
            {{ _('give_up') }}
          </button>
        </div>
      </form>
    </div>
    
    <div style="text-align: center; margin-top: 8px;">
      <button id="guess-btn" type="button" 
              style="width: 80%; padding: 6px; font-size: 9px; font-weight: bold; 
                     background: #E0FFE0; border: 2px solid #000; margin-bottom: 4px;">
        {{ _('i_know') }}
      </button>
    </div>
    
    <div id="guess-form-container" style="display: none; margin-top: 4px;">
      <form id="guess-form" method="post" style="display: flex; gap: 4px; align-items: center;">
        <input type="text" name="user_guess" id="user_guess" 
               placeholder="{{ _('enter_answer') }}" 
               style="flex: 1; padding: 4px; font-size: 8px; border: 1px solid #000;">
        <div id="voice-input-guess"></div>
        <button type="submit" 
                style="padding: 4px 8px; font-size: 8px; font-weight: bold; 
                       background: #D0E0FF; border: 1px solid #000;">
          {{ _('submit_answer') }}
        </button>
      </form>
      
    </div>
    
  {% elif role == 'gpt' %}
    <div style="border: 1px solid #000; padding: 8px; background: #F0F0F0;">
      <div style="font-size: 9px; font-weight: bold; margin-bottom: 6px; text-align: center;">
        {{ _('quick_responses') }}:
      </div>
      
      <div style="display: flex; gap: 4px; margin-bottom: 8px;">
        <form method="post" style="flex: 1;">
          <input type="hidden" name="message" value="ã¯ã„">
          <button type="submit" style="width: 100%; padding: 4px; font-size: 8px; background: #E0E0E0;">
            {{ _('yes') }}
          </button>
        </form>
        
        <form method="post" style="flex: 1;">
          <input type="hidden" name="message" value="ã„ã„ãˆ">
          <button type="submit" style="width: 100%; padding: 4px; font-size: 8px; background: #E0E0E0;">
            {{ _('no') }}
          </button>
        </form>
        
        <form method="post" style="flex: 1;">
          <input type="hidden" name="message" value="ã‚ã‹ã‚‰ãªã„">
          <button type="submit" style="width: 100%; padding: 4px; font-size: 8px; background: #E0E0E0;">
            {{ _('dont_know') }}
          </button>
        </form>
        
        <form method="post" style="flex: 1;">
          <input type="hidden" name="message" value="ã¨ãã©ã">
          <button type="submit" style="width: 100%; padding: 4px; font-size: 8px; background: #E0E0E0;">
            {{ _('sometimes') }}
          </button>
        </form>
      </div>
      
      
      <div style="text-align: center;">
        <form method="post" style="display: inline-block; width: 80%;">
          <input type="hidden" name="message" value="æ­£è§£ï¼">
          <button type="submit" 
                  style="width: 100%; padding: 6px; font-size: 9px; font-weight: bold; 
                         background: #000; color: #FFF; border: 2px solid #000;">
            {{ _('correct_exclamation') }}
          </button>
        </form>
      </div>
    </div>
  {% endif %}
  
{% else %}
  <div class="akinator-game-over" style="border: 2px solid #000; padding: 12px; background: #FFFFFF; text-align: center;">
    <div style="font-size: 10px; font-weight: bold; margin-bottom: 8px;">
      {{ _('game_over') }}
    </div>
    
    <div style="display: flex; gap: 8px; justify-content: center;">
      <a href="{{ url_for('akinator.akinator_restart') }}" 
         style="display: inline-block; padding: 4px 12px; font-size: 9px; 
                background: #C0C0C0; border: 2px outset #C0C0C0; text-decoration: none; color: black;">
        {{ _('play_again') }}
      </a>
      
      <a href="{{ url_for('akinator.akinator_index') }}" 
         style="display: inline-block; padding: 4px 12px; font-size: 9px; 
                background: #C0C0C0; border: 2px outset #C0C0C0; text-decoration: none; color: black;">
        {{ _('change_settings') }}
      </a>
    </div>
  </div>
{% endif %}

<div style="border: 1px dotted #808080; padding: 4px; background: #F0F0F0; font-size: 8px; margin-top: 12px;">
  <div style="font-weight: bold; margin-bottom: 2px;">{{ _('instructions') }}:</div>
  <div>
    {% if role == 'user' %}
      {{ _('ask_questions_about_ai_word') }}
    {% else %}
      {{ _('think_of_jlpt_word') | replace('{level}', session.level or 'N5') }}
    {% endif %}
  </div>
  
    <!-- Educational description for AdSense compliance -->
    <div style="margin-top: 12px; padding: 6px; border: 1px solid #999; background: #F0F8F0; font-size: 8px; line-height: 1.4; color: #333; text-align: left;">
      {{ _('akinator_learning_purpose') }}
    </div>
    
    <!-- UI Debug Panel -->
    <div id="debug-panel" style="margin-top: 16px; padding: 8px; background: #FFE4B5; border: 2px solid #FF6347; font-size: 10px; font-family: monospace;">
      <h4 style="margin: 0 0 8px 0; color: #FF6347;">ğŸ› Sidebar Debug Info</h4>
      <div id="debug-content">Loading debug info...</div>
    </div>
</div> <!-- Close the instructions div from line 161 -->
{% endblock %}

{% block scripts %}
<script>
// Detailed sidebar layout debugging and fixing
(function() {
  'use strict';
  
  function debugAndFixSidebar() {
    const debugPanel = document.getElementById('debug-content');
    let debugHtml = '<div style="color: #333; line-height: 1.4;">';
    
    debugHtml += `<strong>Window width:</strong> ${window.innerWidth}px<br>`;
    debugHtml += `<strong>Document ready:</strong> ${document.readyState}<br><br>`;
    
    const layout = document.querySelector('.sidebar-layout');
    
    if (!layout) {
      debugHtml += '<span style="color: #FF0000;">âŒ No sidebar-layout found!</span><br>';
      debugPanel.innerHTML = debugHtml + '</div>';
      return;
    }
    
    debugHtml += '<span style="color: #008000;">âœ… Sidebar layout found</span><br>';
    debugHtml += `<strong>Children count:</strong> ${layout.children.length}<br>`;
    debugHtml += `<strong>Display style:</strong> ${getComputedStyle(layout).display}<br>`;
    debugHtml += `<strong>Flex direction:</strong> ${getComputedStyle(layout).flexDirection}<br>`;
    debugHtml += `<strong>Layout HTML length:</strong> ${layout.innerHTML.length} chars<br><br>`;
    
    // Check raw HTML structure
    const layoutHtml = layout.innerHTML;
    const firstDiv = layoutHtml.indexOf('<div');
    const secondDiv = layoutHtml.indexOf('<div', firstDiv + 1);
    debugHtml += `<strong>Raw HTML analysis:</strong><br>`;
    debugHtml += `&nbsp;&nbsp;First div position: ${firstDiv}<br>`;
    debugHtml += `&nbsp;&nbsp;Second div position: ${secondDiv}<br>`;
    debugHtml += `&nbsp;&nbsp;Contains "Right side - Sidebar": ${layoutHtml.includes('Right side - Sidebar') ? 'âœ…' : 'âŒ'}<br><br>`;
    
    // Debug each child
    for (let i = 0; i < layout.children.length; i++) {
      const child = layout.children[i];
      const computedStyle = getComputedStyle(child);
      debugHtml += `<strong>Child ${i}:</strong> ${child.tagName}<br>`;
      debugHtml += `&nbsp;&nbsp;Flex: ${computedStyle.flex}<br>`;
      debugHtml += `&nbsp;&nbsp;Width: ${computedStyle.width}<br>`;
      debugHtml += `&nbsp;&nbsp;Min-width: ${computedStyle.minWidth}<br>`;
      debugHtml += `&nbsp;&nbsp;HTML length: ${child.innerHTML.length} chars<br>`;
      debugHtml += `&nbsp;&nbsp;Content preview: ${child.textContent.substring(0, 30)}...<br><br>`;
    }
    
    // Check if sidebar content exists
    const sidebarContent = layout.innerHTML;
    const hasRecommended = sidebarContent.includes('Recommended Practice') || sidebarContent.includes('ãŠã™ã™ã‚ç·´ç¿’');
    const hasBlog = sidebarContent.includes('Latest Blog');
    
    debugHtml += `<strong>Has Recommended Practice:</strong> ${hasRecommended ? 'âœ…' : 'âŒ'}<br>`;
    debugHtml += `<strong>Has Latest Blog:</strong> ${hasBlog ? 'âœ…' : 'âŒ'}<br><br>`;
    
    // Check if content is all in first child (misplaced)
    if (layout.children.length === 1) {
      const firstChildContent = layout.children[0].innerHTML;
      const hasRPInFirstChild = firstChildContent.includes('Recommended Practice') || firstChildContent.includes('ãŠã™ã™ã‚ç·´ç¿’');
      const hasBlogInFirstChild = firstChildContent.includes('Latest Blog');
      debugHtml += `<strong>Content in first child:</strong><br>`;
      debugHtml += `&nbsp;&nbsp;Recommended Practice: ${hasRPInFirstChild ? 'âœ…' : 'âŒ'}<br>`;
      debugHtml += `&nbsp;&nbsp;Latest Blog: ${hasBlogInFirstChild ? 'âœ…' : 'âŒ'}<br><br>`;
      
      // Show a sample of the misplaced content
      if (hasRPInFirstChild) {
        const rpIndex = firstChildContent.indexOf('Recommended Practice');
        const sample = firstChildContent.substring(Math.max(0, rpIndex - 20), rpIndex + 50);
        debugHtml += `<strong>Misplaced sidebar sample:</strong><br>`;
        debugHtml += `<code style="font-size: 8px; background: #f0f0f0; padding: 2px;">${sample}</code><br><br>`;
      }
    }
    
    // Apply fixes if needed
    if (layout.children.length === 2 && window.innerWidth > 768) {
      debugHtml += '<span style="color: #0066CC;">ğŸ”§ Applying layout fixes...</span><br>';
      
      // Force layout styles
      layout.style.cssText = 'display: flex !important; flex-direction: row !important; align-items: flex-start !important; gap: 16px !important; width: 100% !important; margin-bottom: 12px !important;';
      
      // First child (main content)
      const mainContent = layout.children[0];
      mainContent.style.cssText = 'flex: 2 1 auto !important; min-width: 0 !important;';
      
      // Second child (sidebar)  
      const sidebar = layout.children[1];
      sidebar.style.cssText = 'flex: 0 0 250px !important; min-width: 250px !important; max-width: 350px !important;';
      
      debugHtml += '<span style="color: #008000;">âœ… Layout fixes applied</span><br>';
    } else if (layout.children.length !== 2) {
      debugHtml += `<span style="color: #FF6600;">âš ï¸ Expected 2 children, found ${layout.children.length}</span><br>`;
      debugHtml += '<span style="color: #0066CC;">ğŸ” Investigating HTML structure issue...</span><br>';
    }
    
    debugHtml += '</div>';
    debugPanel.innerHTML = debugHtml;
    
    // Also log to console for completeness
    console.log('Sidebar debug complete - children:', layout.children.length);
  }
  
  // Run debugging multiple times to catch different states
  setTimeout(debugAndFixSidebar, 100);
  setTimeout(debugAndFixSidebar, 500);
  setTimeout(debugAndFixSidebar, 1000);
  
  // Also run on DOM ready and load events
  document.addEventListener('DOMContentLoaded', debugAndFixSidebar);
  window.addEventListener('load', debugAndFixSidebar);
  window.addEventListener('resize', debugAndFixSidebar);
})();
</script>

<script>
// Auto-scroll to bottom
function scrollToBottom() {
  const chatArea = document.querySelector('div[style*="overflow-y: auto"]');
  if (chatArea) {
    setTimeout(function() {
      chatArea.scrollTop = chatArea.scrollHeight;
    }, 100);
  }
}

// Auto-focus message input
document.addEventListener('DOMContentLoaded', function() {
  scrollToBottom();
  
  const messageInput = document.getElementById('message');
  if (messageInput) {
    messageInput.focus();
  }
  
  // éŸ³å£°å…¥åŠ›ã®åˆæœŸåŒ– - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ—¥æœ¬èªå›ºå®šï¼‰
  console.log('Debug: Initializing voice input...');
  const voiceInputMessage = document.getElementById('voice-input-message');
  console.log('Debug: voiceInputMessage element:', voiceInputMessage);
  console.log('Debug: messageInput element:', messageInput);
  console.log('Debug: createVoiceInputButton function:', typeof createVoiceInputButton);
  
  if (voiceInputMessage && messageInput) {
    console.log('Debug: Creating voice input button...');
    const voiceInput = createVoiceInputButton('message', {
      language: 'ja',
      buttonText: 'ğŸ¤',
      fixedLanguage: true,
      showLanguageSelect: false
    });
    console.log('Debug: Voice input created:', voiceInput);
    voiceInputMessage.appendChild(voiceInput.container);
    console.log('Debug: Voice input appended to DOM');
  } else {
    console.log('Debug: Missing elements - voiceInputMessage:', !!voiceInputMessage, 'messageInput:', !!messageInput);
  }
  
  // éŸ³å£°å…¥åŠ›ã®åˆæœŸåŒ– - ç­”ãˆå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆæ—¥æœ¬èªå›ºå®šï¼‰
  const voiceInputGuess = document.getElementById('voice-input-guess');
  const guessInput = document.getElementById('user_guess');
  if (voiceInputGuess && guessInput) {
    const voiceGuess = createVoiceInputButton('user_guess', {
      language: 'ja',
      buttonText: 'ğŸ¤',
      fixedLanguage: true,
      showLanguageSelect: false
    });
    voiceInputGuess.appendChild(voiceGuess.container);
  }
  
  
  // ã€Œã‚ã‹ã£ãŸï¼ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
  const guessBtn = document.getElementById('guess-btn');
  const guessFormContainer = document.getElementById('guess-form-container');
  
  if (guessBtn && guessFormContainer && guessInput) {
    guessBtn.addEventListener('click', function() {
      guessBtn.style.display = 'none';
      guessFormContainer.style.display = 'block';
      guessInput.focus();
    });
  }
  
  // ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å¾Œã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  const forms = document.querySelectorAll('form');
  forms.forEach(function(form) {
    form.addEventListener('submit', function() {
      setTimeout(scrollToBottom, 200);
    });
  });
});

// Hint and give up button handlers
document.getElementById('hint-btn')?.addEventListener('click', function() {
  const messageInput = document.getElementById('message');
  if (messageInput) {
    messageInput.value = 'ãƒ’ãƒ³ãƒˆ';
    document.getElementById('chat-form').submit();
  }
});

document.getElementById('giveup-btn')?.addEventListener('click', function() {
  const messageInput = document.getElementById('message');
  if (messageInput) {
    messageInput.value = 'ã“ã†ã•ã‚“';
    document.getElementById('chat-form').submit();
  }
});
</script>

<style>
/* Mobile responsive styles for Akinator game - only apply on small screens */
@media (max-width: 768px) {
  /* Main content adjustments */
  body {
    margin: 0;
    padding: 4px;
  }
  
  /* Title area */
  h1 {
    font-size: 16px !important;
    margin-bottom: 8px !important;
  }
  
  /* Reset/Change button */
  a[style*="font-size: 8px"] {
    font-size: 12px !important;
    padding: 4px 8px !important;
  }
  
  /* Conversation area */
  div[style*="min-height: 120px"] {
    min-height: 150px !important;
    max-height: 250px !important;
    margin-bottom: 16px !important;
  }
  
  /* Conversation messages */
  div[style*="margin-bottom: 6px"] {
    margin-bottom: 8px !important;
    padding: 8px !important;
  }
  
  /* Message text */
  div[style*="font-size: 9px"] {
    font-size: 12px !important;
    line-height: 1.4 !important;
  }
  
  div[style*="font-size: 8px"] {
    font-size: 11px !important;
    line-height: 1.4 !important;
  }
  
  /* Input fields and buttons */
  input[type="text"] {
    font-size: 16px !important; /* Prevent zoom on iOS */
    padding: 12px 8px !important;
    min-height: 44px !important; /* Touch target size */
    box-sizing: border-box !important;
  }
  
  button {
    font-size: 14px !important;
    padding: 12px 8px !important;
    min-height: 44px !important;
    cursor: pointer;
  }
  
  /* Quick response buttons (GPT mode) */
  form[method="post"] button {
    padding: 12px 4px !important;
    font-size: 12px !important;
  }
  
  /* "I Know" button */
  button[id="guess-btn"] {
    width: 90% !important;
    padding: 12px !important;
    font-size: 14px !important;
  }
  
  /* Form containers */
  div[style*="border: 1px solid #000"] {
    padding: 12px !important;
    margin-bottom: 16px !important;
  }
  
  /* Flex containers for buttons only - more specific selectors */
  form[method="post"] > div[style*="display: flex"],
  .akinator-game-over div[style*="display: flex"] {
    gap: 8px !important;
    flex-wrap: wrap;
  }
  
  /* Instructions */
  div[style*="border: 1px dotted #808080"] {
    padding: 8px !important;
    font-size: 10px !important;
    line-height: 1.4 !important;
  }
  
  /* Game over buttons */
  a[style*="padding: 4px 12px"] {
    padding: 12px 16px !important;
    font-size: 12px !important;
    margin: 4px !important;
  }
}

/* Very small screens (phones in portrait) */
@media (max-width: 480px) {
  /* Make conversation area taller on very small screens */
  div[style*="min-height: 120px"] {
    min-height: 200px !important;
    max-height: 300px !important;
  }
  
  /* Adjust button sizes for small screens - specific to form containers */
  form[method="post"] > div[style*="display: flex"] button {
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
  }
  
  /* Stack game over buttons vertically on very small screens */
  .akinator-game-over div[style*="display: flex; gap: 8px; justify-content: center"] {
    flex-direction: column !important;
    align-items: stretch !important;
  }
  
  .akinator-game-over div[style*="display: flex; gap: 8px; justify-content: center"] a {
    text-align: center !important;
  }
}
</style>
{% endblock %}